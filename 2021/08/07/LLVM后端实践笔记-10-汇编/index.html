

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.jpg">
  <link rel="icon" href="/img/avatar.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="P2Tree">
  <meta name="keywords" content="">
  
    <meta name="description" content="10 汇编这一章，我们来添加 Cpu0 的汇编功能，这包括独立汇编器和 C 语言内联汇编特性两个部分。 10.1 汇编器独立汇编器可以理解为依赖于 LLVM 后端提供的接口实现的一个独立软件，因为 LLVM 和 gcc 在这个地方的实现逻辑不一样。 在 gcc 中，编译器和汇编器是两个独立的工具，编译器，也就是 cc，只能生成汇编代码，而汇编器 as，才用来将汇编代码翻译为二进制目标代码，gcc">
<meta property="og:type" content="article">
<meta property="og:title" content="LLVM 后端实践笔记 10：汇编">
<meta property="og:url" content="http://p2tree.github.io/2021/08/07/LLVM%E5%90%8E%E7%AB%AF%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0-10-%E6%B1%87%E7%BC%96/index.html">
<meta property="og:site_name" content="P2Tree Home">
<meta property="og:description" content="10 汇编这一章，我们来添加 Cpu0 的汇编功能，这包括独立汇编器和 C 语言内联汇编特性两个部分。 10.1 汇编器独立汇编器可以理解为依赖于 LLVM 后端提供的接口实现的一个独立软件，因为 LLVM 和 gcc 在这个地方的实现逻辑不一样。 在 gcc 中，编译器和汇编器是两个独立的工具，编译器，也就是 cc，只能生成汇编代码，而汇编器 as，才用来将汇编代码翻译为二进制目标代码，gcc">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://p2tree.github.io/img/20210807/index_small.jpg">
<meta property="article:published_time" content="2021-08-07T15:15:39.000Z">
<meta property="article:modified_time" content="2024-07-21T15:23:29.783Z">
<meta property="article:author" content="P2Tree">
<meta property="article:tag" content="CPP">
<meta property="article:tag" content="LLVM">
<meta property="article:tag" content="编译器">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://p2tree.github.io/img/20210807/index_small.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>LLVM 后端实践笔记 10：汇编 - P2Tree Home</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"p2tree.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"❡"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>P2Tree Home</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/20210807/index.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="LLVM 后端实践笔记 10：汇编"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-08-07 23:15" pubdate>
          August 7, 2021 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.1k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          35 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">LLVM 后端实践笔记 10：汇编</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="10-汇编"><a href="#10-汇编" class="headerlink" title="10 汇编"></a>10 汇编</h2><p>这一章，我们来添加 Cpu0 的汇编功能，这包括独立汇编器和 C 语言内联汇编特性两个部分。</p>
<h2 id="10-1-汇编器"><a href="#10-1-汇编器" class="headerlink" title="10.1 汇编器"></a>10.1 汇编器</h2><p>独立汇编器可以理解为依赖于 LLVM 后端提供的接口实现的一个独立软件，因为 LLVM 和 gcc 在这个地方的实现逻辑不一样。</p>
<p>在 gcc 中，编译器和汇编器是两个独立的工具，编译器，也就是 cc，只能生成汇编代码，而汇编器 as，才用来将汇编代码翻译为二进制目标代码，gcc 驱动软件 gcc 将这些工具按顺序驱动起来（还包括预处理器、链接器等），最终实现从 C 语言到二进制目标代码的功能。但是，这样的设计有个缺点，每个工具都需要先对输入文件做 parse，然后再输出时写入文件，反复多次的磁盘读写一定程度影响了编译的效率。</p>
<p>而在 LLVM 中，编译器后端本身就可以将中间代码（对应 gcc 中 cc 的中间表示）翻译成二进制目标文件，而不需要发射汇编代码到文件中，再重新 parse 汇编文件。当然它也可以通过配置命令行参数指定将中间代码翻译成汇编代码，方便展示底层程序逻辑。</p>
<p>但我们目前已经实现的这些功能，却无法支持输入汇编代码，输出二进制目标文件，虽然通常情况下已经不再需要手工编写汇编代码，但在特殊情况下，比如引导程序、调试特殊功能、需要优化性能等场合下，还是需要编写汇编代码，所以一个汇编器依然是很重要的。</p>
<p>显然，我们之前的章节已经把和指令相关的汇编表示都在 TableGen 中实现了，这一节中，最核心的就是实现一个汇编器的 parser，并将其注册到 LLVM 后端框架中，并使能汇编功能。并且，汇编器的核心功能在 LLVM 中也已经实现了，原理其实就是一个语法制导的翻译，我们要做的只是重写其中部分和后端架构相关的接口。</p>
<p>我还实现了一个额外的特性。当我们仅使用汇编器时，编译器占用的寄存器 <code>$sw</code>，就可以被释放出来当做普通寄存器用了，所以我们重新定义一下 GPROut 这个寄存器类别，并将 <code>Cpu0.td</code> 拆分成两份，将它拆分为 <code>Cpu0Asm.td</code> 和 <code>Cpu0Other.td</code>，前者会在调用汇编器时被使用到，而后者保持和之前一样的设计。</p>
<p>因为 <code>$sw</code> 寄存器是编译器用来记录状态的，如果只编写汇编代码，我们认为程序员有义务去维护这个寄存器中的值什么时候是有效的，进而程序员就可以在认为这个寄存器中值无效时，把它当做普通寄存器来使用。我们的标量寄存器有很多，多这样一个寄存器的意义并不是很大，这里依然这么做，其实是想展示一下 TableGen 机制的灵活性。</p>
<p>在 Cpu0 的后端代码路径下，新建一个子目录 AsmParser，在这个路径下新建 Cpu0AsmParser.cpp 用来实现绝大多数功能。</p>
<h3 id="10-1-1-文件新增"><a href="#10-1-1-文件新增" class="headerlink" title="10.1.1 文件新增"></a>10.1.1 文件新增</h3><h4 id="1-AsmParser-Cpu0AsmParser-cpp"><a href="#1-AsmParser-Cpu0AsmParser-cpp" class="headerlink" title="(1) AsmParser&#x2F;Cpu0AsmParser.cpp"></a>(1) AsmParser&#x2F;Cpu0AsmParser.cpp</h4><p>作为一个独立的功能模块，使能它的 DEBUG 信息名称为 <code>cpu0-asm-parser</code>，声明一些新的 class： <code>Cpu0AsmParser</code> 作为核心类，用来处理所有汇编 parser 的工作，我们稍后介绍；<code>Cpu0AssemblerOptions</code> 这个类用来做汇编器参数的管理；<code>Cpu0Operand</code> 类用来解析指令操作数，因为指令操作数可能有各种不同的类型，所以将这部分单独抽出来实现。</p>
<p>在 class 声明之后，就是 class 中成员函数的实现代码。</p>
<p><code>Cpu0AsmParser</code> 类继承了基类 <code>MCTargetAsmParser</code>，并重写了部分接口，而有关于汇编 parser 的详细逻辑可以参考 AsmParser.cpp 中的实现。</p>
<p>两个比较重要的重写函数：<code>MatchAndEmitInstruction()</code>， <code>ParseInstruction()</code> 。</p>
<p>汇编器在做 parser 时，要先做 Parse，然后再对符合语法规范的指令做指令匹配，前者的关键函数就是第 2 个函数 <code>ParseInstruction()</code>，后者的关键函数就是第 1 个 <code>MatchAndEmitInstruction()</code>。</p>
<p>在 <code>ParseInstruction()</code> 中，根据传入的词法记号，解析指令助记符存入 Operands 容器中，然后在后边依次解析每个操作数，也存入 Operands 中。对于不满足语法规范的输入，比如操作数之间缺逗号等这种问题，直接报错并退出。在解析操作数时，调用了 <code>ParseOperand()</code> 接口，这也是一个很重要的接口，专用来解析操作数，我们也重写了这个接口以适应我们的类型，尤其是地址运算符。</p>
<p><code>ParseInstruction()</code> 执行完毕后会返回到 <code>AsmParser.cpp</code> 中的 <code>parseStatement</code> 方法中，并在做一些分析后，再调用到 <code>MatchAndEmitInstruction()</code> 方法。</p>
<p>在 <code>MatchAndEmitInstruction()</code> 函数中，将 Operands 容器对象传入。首先调用 <code>MatchInstructionImpl</code> 函数，这个函数是 TableGen 参考我们的指令 td 文件生成的 Cpu0GenAsmMatcher.inc 文件自动生成的。</p>
<p>匹配之后如果成功了，还需要做额外的处理，如果这个是伪指令，需要汇编器展开，这种指令我们设计了几条，在之后会提到，这种指令需要调用 <code>expandInstruction()</code> 函数来展开，后者根据对应指令调用对应的展开函数，如果不是伪指令，就调用 <code>EmitInstruction()</code> 接口来发射编码，这个函数与我们前边章节设计指令输出的接口是同一个，也就是说在汇编 parser 之后的代码，是复用了之前的代码。</p>
<p>匹配如果失败了，则做简单处理并返回，这里我们只实现了几种简单的情况，如果你的后端有一些 TableGen 支持不了的指令形式，也可以在这里做额外的处理，不过还是尽量去依赖 TableGen 的匹配表为好。</p>
<p>在 <code>ParseOperand()</code> 函数中，将前边 parse 出来的 Operands 容器对象传入。首先调用 <code>MatchOperandParserImpl()</code> 函数来 parse 操作数，这个函数也是 Cpu0GenAsmMatcher.inc 文件中定义好的。如果这个函数 parse 成功，就返回， 否则继续在下边完成一些自定义的 parse 动作，在一个 switch 分支中，根据词法 token 的类型来分别处理。其中，对于 Token，可能是一个寄存器，调用 <code>tryParseRegisterOperand()</code> 函数来处理，如果没有解析成功，则按照标识符处理；对于标识符、加减运算符和数字等 Token 的情况，统一调用 <code>parseExpression()</code> 来处理；对于百分号 Token，表示可能是一个重定位信息，比如 <code>%hi($r1)</code>，则调用 <code>parseRelocOperand()</code> 函数来处理。</p>
<p>其他函数就不一一说明了，其中包括很多在 parse 操作数时，不同的操作数下的特殊处理，还有伪指令的展开动作，重定位操作数的格式解析以及生成重定位表达式，寄存器、立即数的 parse，还有汇编宏指令的解析（比如 <code>.macro</code>, <code>.cpload</code> 这一类）。</p>
<p>在最后，这些代码都实现完毕后，需要调用 <code>RegisterMCAsmParser</code> 接口将汇编 parser 注册到 LLVM 中，这个步骤写入到 <code>LLVMInitializeCpu0AsmParser()</code> 函数中。</p>
<h4 id="2-AsmParser-CMakeLists-txt"><a href="#2-AsmParser-CMakeLists-txt" class="headerlink" title="(2) AsmParser&#x2F;CMakeLists.txt"></a>(2) AsmParser&#x2F;CMakeLists.txt</h4><p>新增加子路径下的编译配置文件。</p>
<h4 id="3-AsmParser-LLVMBuild-txt"><a href="#3-AsmParser-LLVMBuild-txt" class="headerlink" title="(3) AsmParser&#x2F;LLVMBuild.txt"></a>(3) AsmParser&#x2F;LLVMBuild.txt</h4><p>同上，添加 LLVM 构建编译配置。</p>
<h4 id="4-Cpu0RegisterInfoGPROutForAsm-td"><a href="#4-Cpu0RegisterInfoGPROutForAsm-td" class="headerlink" title="(4) Cpu0RegisterInfoGPROutForAsm.td"></a>(4) Cpu0RegisterInfoGPROutForAsm.td</h4><p>在这个文件中，我们定义的 GPROut 类别是支持完整的 CPURegs 的。</p>
<h4 id="5-Cpu0RegisterInfoGPROutForOther-td"><a href="#5-Cpu0RegisterInfoGPROutForOther-td" class="headerlink" title="(5) Cpu0RegisterInfoGPROutForOther.td"></a>(5) Cpu0RegisterInfoGPROutForOther.td</h4><p>在这个文件中，我们定义的 GPROut 类别不包含 <code>$sw</code> 寄存器。</p>
<h4 id="6-Cpu0Asm-td"><a href="#6-Cpu0Asm-td" class="headerlink" title="(6) Cpu0Asm.td"></a>(6) Cpu0Asm.td</h4><p>由 <code>Cpu0.td</code> 拆分出来的文件，和 <code>Cpu0Other.td</code> 对应，包含了文件 <code>Cpu0RegisterInfoGPROutForAsm.td</code>。</p>
<h4 id="7-Cpu0Other-td"><a href="#7-Cpu0Other-td" class="headerlink" title="(7) Cpu0Other.td"></a>(7) Cpu0Other.td</h4><p>由 <code>Cpu0.td</code> 拆分出来的文件，和 <code>Cpu0Asm.td</code> 对应，包含了文件 <code>Cpu0RegisterInfoGPROutForOther.td</code>。</p>
<h3 id="10-1-2-文件修改"><a href="#10-1-2-文件修改" class="headerlink" title="10.1.2 文件修改"></a>10.1.2 文件修改</h3><h4 id="1-CMakeLists-txt"><a href="#1-CMakeLists-txt" class="headerlink" title="(1) CMakeLists.txt"></a>(1) CMakeLists.txt</h4><p>添加子路径的配置。同时，还需要添加一个新的 tablegen 配置项，要求 TableGen 生成 Cpu0GenAsmMatcher.inc 文件用来做汇编指令匹配。</p>
<h4 id="2-LLVMBuild-txt"><a href="#2-LLVMBuild-txt" class="headerlink" title="(2) LLVMBuild.txt"></a>(2) LLVMBuild.txt</h4><p>同上。</p>
<h4 id="3-Cpu0-td"><a href="#3-Cpu0-td" class="headerlink" title="(3) Cpu0.td"></a>(3) Cpu0.td</h4><p>删掉 Target.td、Cpu0RegisterInfo.td 文件的包含。添加汇编器 parser 在 td 中的定义，并注册到 Cpu0 的属性中。这些都是常规操作。</p>
<h4 id="4-Cpu0InstrFormats-td"><a href="#4-Cpu0InstrFormats-td" class="headerlink" title="(4) Cpu0InstrFormats.td"></a>(4) Cpu0InstrFormats.td</h4><p>增加针对伪指令的描述性 class，继承自 <code>Cpu0Pseudo</code> 类。</p>
<h4 id="5-Cpu0InstrInfo-td"><a href="#5-Cpu0InstrInfo-td" class="headerlink" title="(5) Cpu0InstrInfo.td"></a>(5) Cpu0InstrInfo.td</h4><p>增加 Operand 操作数 class 中 <code>ParserMatchClass</code> 和 <code>ParserMethod</code> 属性的描述，只有这样，td 中的操作数才会支持汇编 parse。</p>
<p>定义伪指令 <code>LoadImm32Reg</code>, <code>LoadAddr32Reg</code>, <code>LoadAddr32Imm</code>，这几个指令会在 <code>Cpu0AsmParser.cpp</code> 中实现对应的展开函数 <code>expandLoadImm()</code>, <code>expandLoadAddressImm</code> 和 <code>expandLoadAddressReg</code>，这些函数统一放到 <code>expandInstruction()</code> 中管理，后者在 <code>MatchAndEmitInstruction()</code> 函数中被调用。</p>
<h4 id="6-Cpu0RegisterInfo-td"><a href="#6-Cpu0RegisterInfo-td" class="headerlink" title="(6) Cpu0RegisterInfo.td"></a>(6) Cpu0RegisterInfo.td</h4><p>将 GPROut 的定义移动到 <code>Cpu0RegisterInfoGPROutForAsm.td</code> 和 <code>Cpu0RegisterInfoGPROutForOther.td</code> 中。</p>
<h3 id="10-1-3-验证结果"><a href="#10-1-3-验证结果" class="headerlink" title="10.1.3 验证结果"></a><strong>10.1.3 验证结果</strong></h3><p>这些函数的部分调用关系如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">1. ParseInstruction() -&gt; ParseOperand() -&gt; MatchOperandParserImpl() -&gt; tryCustomParseOperand() -&gt; parseMemOperand() -&gt; parseMemOffset(), tryParseRegisterOperand()<br>2. MatchAndEmitInstruction() -&gt; MatchInstructionImpl(), needsExpansion(), expandInstruction()<br>3. parseMemOffset() -&gt; parseRelocOperand() -&gt; getVariantKind()<br>4. tryParseRegisterOperand() -&gt; tryParseRegister() -&gt; matchRegisterName() -&gt; getReg(), matchRegisterByNumber()<br>5. expandInstruction() -&gt;expandLoadImm(), expandLoadAddressImm(), expandLoadAddressReg() -&gt; EmitInstruction()<br>6. ParseDirective() -&gt; parseDirectiveSet() -&gt; parseSetReorderDirective(), parseSetNoReorderDirective(), parseSetMacroDirective(), parseSetNoMacroDirective() -&gt; reportParseError()<br></code></pre></td></tr></table></figure>

<p>编译本章第一个 case ch10_1.s，这是一个汇编文件，LLVM 的独立汇编器软件名为 llvm-mc，mc 意指 MCInstr 表示格式，它是一种比 MI 格式更底层的一种中间表示，清除很多信息，在汇编器中使用。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">build/bin/llvm-mc -triple=cpu0 -filetype=obj ch10_1.s -o ch10_1.o<br></code></pre></td></tr></table></figure>

<p>如果没有出错，那就成功汇编了，使用 llvm-objdump 工具反汇编代码来查看结果。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">build/bin/llvm-objdump -d ch10_1.o<br></code></pre></td></tr></table></figure>

<h2 id="10-2-内联汇编"><a href="#10-2-内联汇编" class="headerlink" title="10.2 内联汇编"></a>10.2 内联汇编</h2><p>当 c 程序需要直接访问特殊寄存器、指令或内存时，就需要内联汇编的支持，内联汇编允许直接在 c 程序中嵌入汇编代码，来完成机器层次级别的操作。clang 支持内联汇编，但因为汇编是后端的概念，所以内联汇编也自然需要后端来配合支持。</p>
<h3 id="10-2-1-简要说明"><a href="#10-2-1-简要说明" class="headerlink" title="10.2.1 简要说明"></a>10.2.1 简要说明</h3><p>一个简单的内联汇编格式是：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">__asm__ __volatile__ (&quot;addu %0, %1, %2&quot;<br>                      : &quot;=r&quot; (a)<br>                      : &quot;r&quot; (b), &quot;r&quot; (c));<br></code></pre></td></tr></table></figure>

<p>其中第一行的 <code>__asm__</code> 是必须要有的，用来指明后边是内联汇编表达式；<code>__volatile__</code> 用来告诉编译器不要对这段代码做调整和优化，可以选择加上。</p>
<p>括号中第一行是要添加的指令，可以多行加入多个这样的字符串，用来一次性添加多条指令，指令字符串末尾不带分号；除了<code>%</code> 开头的操作数以外，其他内容要与标准汇编格式一致，<code>%</code> 开头的操作数作为占位符，会在内联汇编中用于与 c 变量或内存做绑定；这种占位符形式与下边变量的绑定是按照数字顺序依次对应，比如本例中 <code>%0</code> 对应 <code>a</code> 变量，<code>%1</code> 对应 <code>b</code> 变量。除此之外，还有一种命名绑定法，不再详细介绍。</p>
<p>第一个 <code>:</code> 之后的内容是输出的定义，这里的输出，包括下边的输入和 clobber list，都是用来修饰整个内联汇编块的，如果有多条指令，这里也仅表示整个指令块的输出，而不是某一条指令的输出；后边第一个字符串是操作数约束 constraint，用来描述这个操作数的类型，具体类型有很多，可以参考 gcc 标准内联汇编的格式，LLVM 采用兼容 gcc 标准内联汇编的策略，绝大多数约束保持了一致；之后小括号中的内容是 c 语言代码中的变量名，表示要绑定的变量。</p>
<p>第二个 <code>:</code> 之后的内容是输入的定义，与输出定义表现方式一致。</p>
<p>其实还可能有第三个 <code>:</code>，用来表示特殊约束 clobber，不展开介绍。</p>
<p>这三个 <code>:</code> 之后的内容可以选择性省略，但不能省略 <code>:</code>。</p>
<p>虽然内联汇编的格式挺复杂，但庆幸的是这些 parse 的工作大部分都已经由 clang 和 LLVM 完成了，clang 不需要我们做修改，凡是字符串中的内容，都会直接传给后端，而显然内联汇编的格式也依照此策略方便的隔离了前后端（意思是字符串中的内容才和后端相关，非字符串的格式由前端处理）。</p>
<p>我们需要做的工作在后端，主要是对一些自定义的类型、操作方式和约束做定义，如果你的后端是一个很简单的后端，甚至在这里都不需要做什么工作，LLVM 本身已经支持了很多标准操作。</p>
<h3 id="10-2-1-修改文件"><a href="#10-2-1-修改文件" class="headerlink" title="10.2.1 修改文件"></a>10.2.1 修改文件</h3><h4 id="1-Cpu0AsmPrinter-h-cpp"><a href="#1-Cpu0AsmPrinter-h-cpp" class="headerlink" title="(1) Cpu0AsmPrinter.h&#x2F;.cpp"></a>(1) Cpu0AsmPrinter.h&#x2F;.cpp</h4><p>重写 <code>PrintAsmOperand()</code> 函数，该函数用来指定内联汇编表达式的自定义输出样式，比如当修饰符是 <code>z</code> 时，表示这个值是一个非负立即数，我们希望在立即数为 0 时，不输出 0 而是输出 <code>$0</code>，就在这里完成。如果没有匹配到，就会调用 LLVM 内建的 <code>AsmPrinter::PrintAsmOperand()</code> 函数完成默认处理。如果没有指定约束类型，则会走到 <code>printOperand()</code> 函数打印出可能的重定位形式的汇编代码。</p>
<p>重写<code>PrintAsmMemoryOperand()</code> 函数，与上边同理，这个函数只负责处理内存操作的操作数。我们额外定义了我们自己的汇编格式中对内存访问的表示形式，即 <code>10($2)</code> 这种样式。</p>
<h4 id="2-Cpu0ISelDAGToDAG-h-cpp"><a href="#2-Cpu0ISelDAGToDAG-h-cpp" class="headerlink" title="(2) Cpu0ISelDAGToDAG.h&#x2F;.cpp"></a>(2) Cpu0ISelDAGToDAG.h&#x2F;.cpp</h4><p>这里重写了一个函数<code>SelectInlineAsmMemoryOperand()</code>，该函数用来约定内存操作数在指令选择时的动作，对于内存操作，因为其表现是重定位字符串，所以不需要在编译器这里做处理，所以直接将 OP，就是对应的 node，保存下来并返回 false，告诉 LLVM 不需要对其进行下降。</p>
<h4 id="3-Cpu0ISelLowering-h-cpp"><a href="#3-Cpu0ISelLowering-h-cpp" class="headerlink" title="(3) Cpu0ISelLowering.h&#x2F;.cpp"></a>(3) Cpu0ISelLowering.h&#x2F;.cpp</h4><p>除了特殊的地址操作数之外，就剩下寄存器和立即数操作数了，立即数操作数会由 LLVM 自动的依据 Cpu0GenRegisterInfo.inc 中的信息做绑定，留下特殊的立即数操作数需要我们做处理。因为立即数编码是指令中的一部分，LLVM 公共环境并不知道我们可能支持哪些宽度的立即数，所以其代码需要手动添加。</p>
<p>我们重写了几个函数，其中关键的一个是 <code>LowerAsmOperandForConstraint()</code> ，这个函数对所有可能的自定义的约束做处理，处理完特殊情况之后，会转到 LLVM 公共的 <code>TargetLowering::LowerAsmOperandForConstraint()</code>。</p>
<p>其他几个函数用来配合寄存器约束的解析，具体可以参考代码中注释。</p>
<p>另外，内联汇编还支持将一个操作数约束成多个可能的类型，比如一个立即数，可以约束为几个不同有效编码范围的立即数类型。后端会使用 <code>getSingleConstraintMatchWeight()</code> 函数来决定一个权重，根据权重来选择最佳匹配的类型。</p>
<h4 id="4-Cpu0InstrInfo-cpp"><a href="#4-Cpu0InstrInfo-cpp" class="headerlink" title="(4) Cpu0InstrInfo.cpp"></a>(4) Cpu0InstrInfo.cpp</h4><p>增加计算内联汇编指令长度的计算代码。</p>
<p>LLVM 中处理内联汇编的主要逻辑在 <code>TargetLowering.cpp</code> 文件中，对于我们上边几个文件中重写的接口函数都有调用，而且因为核心逻辑是标准的，只要我们不在内联汇编的代码语法上做调整，就不需要修改到公共代码。至于如寄存器类型多而导致寄存器约束多（比如可能会自定义多种向量寄存器，新建如 <code>v</code>， <code>t</code> 等约束）， 或者立即数编码形式多、内存寻址方式多，都可以在后端的上述几个函数中做调整。</p>
<h3 id="10-2-3-检验成果"><a href="#10-2-3-检验成果" class="headerlink" title="10.2.3 检验成果"></a>10.2.3 检验成果</h3><p>运行 ch10_2.c 的代码，其中已经编写了几种简单的内联汇编的代码。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">build/bin/clang -target mips-unknown-linux-gnu -c ch10_2.c -S -emit-llvm -o ch10_2.ll<br></code></pre></td></tr></table></figure>

<p>检查 IR 文件。LLVM IR 也有一种特殊的内联汇编表现样式：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">%1 = call i32 asm sideeffect &quot;addu $0, $1, $2&quot;, &quot;=r,r,r,~&#123;$1&#125;&quot;(i32 %0, i32 %1) #1, !srcloc !2<br></code></pre></td></tr></table></figure>

<p>它用 <code>asm</code> 作为一个特殊的操作节点，这个节点在后端会被当做内联汇编的块做 lowering。</p>
<p>编译为汇编代码：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">build/bin/llc -march=cpu0 -mcpu=cpu032I -relocation-model=pic -filetype=asm ch10_2.ll -o -<br></code></pre></td></tr></table></figure>

<p>检查汇编文件中，使用 <code>#APP</code> 和 <code>#NO_APP</code> 包含在中间的代码就是内联汇编代码。内联汇编默认的标识是 <code>#APP</code>，这个符号也可以修改。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/" class="category-chain-item">软件开发</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/CPP/" class="print-no-link">#CPP</a>
      
        <a href="/tags/LLVM/" class="print-no-link">#LLVM</a>
      
        <a href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" class="print-no-link">#编译器</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>LLVM 后端实践笔记 10：汇编</div>
      <div>http://p2tree.github.io/2021/08/07/LLVM后端实践笔记-10-汇编/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>P2Tree</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>August 7, 2021</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/09/10/LLVM%E5%90%8E%E7%AB%AF%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0-%E9%99%84%E5%BD%95A-%E4%BD%BF%E7%94%A8Simulator%E9%AA%8C%E8%AF%81%E7%BC%96%E8%AF%91%E5%99%A8/" title="LLVM 后端实践笔记 附录A：使用 Simulator 验证编译器">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">LLVM 后端实践笔记 附录A：使用 Simulator 验证编译器</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/07/31/LLVM%E5%90%8E%E7%AB%AF%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0-9-ELF%E6%96%87%E4%BB%B6%E6%94%AF%E6%8C%81/" title="LLVM后端实践笔记 9：ELF文件支持">
                        <span class="hidden-mobile">LLVM后端实践笔记 9：ELF文件支持</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'p2tree/p2tree.github.io');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Views: 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Visitors: 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
