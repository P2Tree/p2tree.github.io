class LocalSearch{constructor({path:e="",unescape:t=false,top_n_per_article:n=1}){this.path=e;this.unescape=t;this.top_n_per_article=n;this.isfetched=false;this.datas=null}getIndexByWord(e,s,l=false){const o=[];const r=new Set;if(!l){s=s.toLowerCase()}e.forEach(e=>{if(this.unescape){const a=document.createElement("div");a.innerText=e;e=a.innerHTML}const t=e.length;if(t===0)return;let n=0;let i=-1;if(!l){e=e.toLowerCase()}while((i=s.indexOf(e,n))>-1){o.push({position:i,word:e});r.add(e);n=i+t}});o.sort((e,t)=>{if(e.position!==t.position){return e.position-t.position}return t.word.length-e.word.length});return[o,r]}mergeIntoSlice(e,t,n){let i=n[0];let{position:a,word:s}=i;const l=[];const o=new Set;while(a+s.length<=t&&n.length!==0){o.add(s);l.push({position:a,length:s.length});const r=a+s.length;n.shift();while(n.length!==0){i=n[0];a=i.position;s=i.word;if(r>a){n.shift()}else{break}}}return{hits:l,start:e,end:t,count:o.size}}highlightKeyword(e,t){let n="";let i=t.start;for(const{position:a,length:s}of t.hits){n+=e.substring(i,a);i=a+s;n+=`<mark class="search-keyword">${e.substr(a,s)}</mark>`}n+=e.substring(i,t.end);return n}getResultItems(w){const P=[];this.datas.forEach(({title:e,content:t,url:n})=>{const[i,a]=this.getIndexByWord(w,e);const[s,l]=this.getIndexByWord(w,t);const o=new Set([...a,...l]).size;const r=i.length+s.length;if(r===0)return;const c=[];if(i.length!==0){c.push(this.mergeIntoSlice(0,e.length,i))}let h=[];while(s.length!==0){const u=s[0];const{position:p}=u;const f=Math.max(0,p-20);const m=Math.min(t.length,p+100);h.push(this.mergeIntoSlice(f,m,s))}h.sort((e,t)=>{if(e.count!==t.count){return t.count-e.count}else if(e.hits.length!==t.hits.length){return t.hits.length-e.hits.length}return e.start-t.start});const d=parseInt(this.top_n_per_article,10);if(d>=0){h=h.slice(0,d)}let g="";n=new URL(n,location.origin);n.searchParams.append("highlight",w.join(" "));if(c.length!==0){g+=`<li class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${this.highlightKeyword(e,c[0])}</span>`}else{g+=`<li class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${e}</span>`}h.forEach(e=>{g+=`<p class="search-result">${this.highlightKeyword(t,e)}...</p></a>`});g+="</li>";P.push({item:g,id:P.length,hitCount:r,includedCount:o})});return P}fetchData(){const t=!this.path.endsWith("json");fetch(this.path).then(e=>e.text()).then(e=>{this.isfetched=true;this.datas=t?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(e);this.datas=this.datas.filter(e=>e.title).map(e=>{e.title=e.title.trim();e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");return e});window.dispatchEvent(new Event("search:loaded"))})}highlightText(t,e,n){const i=t.nodeValue;let a=e.start;const s=[];for(const{position:l,length:o}of e.hits){const r=document.createTextNode(i.substring(a,l));a=l+o;const c=document.createElement("mark");c.className=n;c.appendChild(document.createTextNode(i.substr(l,o)));s.push(r,c)}t.nodeValue=i.substring(a,e.end);s.forEach(e=>{t.parentNode.insertBefore(e,t)})}highlightSearchWords(e){const t=new URL(location.href).searchParams.get("highlight");const i=t?t.split(" "):[];if(!i.length||!e)return;const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);const a=[];while(n.nextNode()){if(!n.currentNode.parentNode.matches("button, select, textarea, .mermaid"))a.push(n.currentNode)}a.forEach(e=>{const[t]=this.getIndexByWord(i,e.nodeValue);if(!t.length)return;const n=this.mergeIntoSlice(0,e.nodeValue.length,t);this.highlightText(e,n,"search-keyword")})}}window.addEventListener("load",()=>{const{path:e,top_n_per_article:t,unescape:n,languages:c,pagination:i}=GLOBAL_CONFIG.localSearch;const h=i&&i.enable;const a=new LocalSearch({path:e,top_n_per_article:t,unescape:n});const s=document.querySelector(".local-search-input input");const d=document.getElementById("local-search-stats");const l=document.getElementById("loading-status");const o=!e.endsWith("json");let g=0;const u=i.hitsPerPage||10;let p=[];if(!h){g=undefined;p=undefined}const f={get pagination(){return document.getElementById("local-search-pagination")},get paginationList(){return document.querySelector("#local-search-pagination .ais-Pagination-list")}};const m=e=>{if(h){f.pagination.style.display=e?"":"none"}else{f.pagination.style.display="none"}};const w=(e,t)=>{const n=document.getElementById("local-search-results");const i=h?p.slice(g*u,(g+1)*u):t;if(h&&i.length===0&&p.length>0){g=0;w(e,t);return}const a=i.map((e,t)=>{const n=h?g*u+t+1:t+1;return e.item.replace('<li class="local-search-hit-item">',`<li class="local-search-hit-item" value="${n}">`)});n.innerHTML=`<ol class="search-result-list">${a.join("")}</ol>`;const s=h?p.length:t.length;const l=c.hits_stats.replace(/\$\{hits}/,s);d.innerHTML=`<hr><div class="search-result-stats">${l}</div>`;if(h){const r=Math.ceil(p.length/u);P(g,r,e)}const o=t.length>0;m(o);window.pjax&&window.pjax.refresh(n)};const P=(t,e,n)=>{if(e<=1){f.pagination.style.display="none";f.paginationList.innerHTML="";return}f.pagination.style.display="block";const i=t===0;const a=t===e-1;const s=window.innerWidth<768;const l=s?3:5;let o=Math.max(0,t-Math.floor(l/2));const r=Math.min(e-1,o+l-1);if(r-o+1<l){o=Math.max(0,r-l+1)}let c="";if(e>l&&o>0){c+=`
        <li class="ais-Pagination-item ais-Pagination-item--page">
          <a class="ais-Pagination-link" aria-label="Page 1" href="#" data-page="0">1</a>
        </li>`;if(o>1){c+=`
          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">
            <span class="ais-Pagination-link">...</span>
          </li>`}}for(let e=o;e<=r;e++){const h=e===t;if(h){c+=`
          <li class="ais-Pagination-item ais-Pagination-item--page ais-Pagination-item--selected">
            <span class="ais-Pagination-link" aria-label="Page ${e+1}">${e+1}</span>
          </li>`}else{c+=`
          <li class="ais-Pagination-item ais-Pagination-item--page">
            <a class="ais-Pagination-link" aria-label="Page ${e+1}" href="#" data-page="${e}">${e+1}</a>
          </li>`}}if(e>l&&r<e-1){if(r<e-2){c+=`
          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">
            <span class="ais-Pagination-link">...</span>
          </li>`}c+=`
        <li class="ais-Pagination-item ais-Pagination-item--page">
          <a class="ais-Pagination-link" aria-label="Page ${e}" href="#" data-page="${e-1}">${e}</a>
        </li>`}if(e>1){f.paginationList.innerHTML=`
            <li class="ais-Pagination-item ais-Pagination-item--previousPage ${i?"ais-Pagination-item--disabled":""}">
              ${i?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Previous Page"><i class="fas fa-angle-left"></i></span>':`<a class="ais-Pagination-link" aria-label="Previous Page" href="#" data-page="${t-1}"><i class="fas fa-angle-left"></i></a>`}
            </li>
            ${c}
            <li class="ais-Pagination-item ais-Pagination-item--nextPage ${a?"ais-Pagination-item--disabled":""}">
              ${a?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Next Page"><i class="fas fa-angle-right"></i></span>':`<a class="ais-Pagination-link" aria-label="Next Page" href="#" data-page="${t+1}"><i class="fas fa-angle-right"></i></a>`}
            </li>`}else{f.pagination.style.display="none"}};const r=()=>{const e=document.getElementById("local-search-results");e.textContent="";d.textContent="";m(false);if(h){p=[];g=0}};const y=e=>{const t=document.getElementById("local-search-results");t.textContent="";const n=document.createElement("div");n.className="search-result-stats";n.textContent=c.hits_empty.replace(/\$\{query}/,e);d.innerHTML=n.outerHTML;m(false);if(h){p=[];g=0}};const b=()=>{if(!a.isfetched)return;let e=s.value.trim().toLowerCase();o&&(e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;"));if(e!=="")l.hidden=false;const t=e.split(/[-\s]+/);let n=[];if(e.length>0){n=a.getResultItems(t)}if(t.length===1&&t[0]===""){r()}else if(n.length===0){y(e)}else{n.sort((e,t)=>{if(e.includedCount!==t.includedCount){return t.includedCount-e.includedCount}else if(e.hitCount!==t.hitCount){return t.hitCount-e.hitCount}return t.id-e.id});if(h){p=n;g=0}w(e,n)}l.hidden=true};let E=false;const x=document.getElementById("search-mask");const L=document.querySelector("#local-search .search-dialog");const v=()=>{if(window.innerWidth<768){L.style.setProperty("--search-height",window.innerHeight+"px")}};const S=()=>{btf.overflowPaddingR.add();btf.animateIn(x,"to_show 0.5s");btf.animateIn(L,"titleScale 0.5s");setTimeout(()=>{s.focus()},300);if(!E){!a.isfetched&&a.fetchData();s.addEventListener("input",b);E=true}document.addEventListener("keydown",function e(t){if(t.code==="Escape"){k();document.removeEventListener("keydown",e)}});v();window.addEventListener("resize",v)};const k=()=>{btf.overflowPaddingR.remove();btf.animateOut(L,"search_close .5s");btf.animateOut(x,"to_hide 0.5s");window.removeEventListener("resize",v)};const I=()=>{btf.addEventListenerPjax(document.querySelector("#search-button > .search"),"click",S)};const $=()=>{document.querySelector("#local-search .search-close-button").addEventListener("click",k);x.addEventListener("click",k);if(GLOBAL_CONFIG.localSearch.preload){a.fetchData()}a.highlightSearchWords(document.getElementById("article-container"));if(h){f.pagination.addEventListener("click",e=>{e.preventDefault();const t=e.target.closest("a[data-page]");if(t){const n=parseInt(t.dataset.page,10);if(!isNaN(n)&&p.length>0){g=n;w(s.value.trim().toLowerCase(),p)}}})}m(false)};window.addEventListener("search:loaded",()=>{const e=document.getElementById("loading-database");e.nextElementSibling.style.visibility="visible";e.remove()});I();$();window.addEventListener("pjax:complete",()=>{!btf.isHidden(x)&&k();a.highlightSearchWords(document.getElementById("article-container"));I()})});